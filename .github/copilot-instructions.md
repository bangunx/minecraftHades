# Copilot Instructions for Three.js Voxel World

## Architecture Overview

This is a **modular Three.js voxel engine** (Minecraft-like) built with ES6 modules and Vite. The architecture follows strict separation of concerns:

- **Core** (`src/core/`) - Game bootstrap, renderer, camera, lighting, game loop
- **World** (`src/world/`) - Chunk-based terrain with instanced rendering, procedural generation via layered noise
- **Player** (`src/player/`) - First-person controller with collision detection, pointer lock controls
- **Textures** (`src/textures/`) - Canvas-based procedural texture generation (no external image assets)
- **UI** (`src/ui/`) - HUD and minimap overlays

### Key Data Flow

1. `main.js` → `Game` class initializes all subsystems
2. `World` generates chunks on-demand within render distance (4 chunks default)
3. `GameLoop` ticks at 60fps: `update(delta)` → `render()`
4. Player input → physics → collision detection → camera sync
5. Block interactions trigger chunk rebuilds via dirty flagging

## Critical Patterns

### Chunk Management (`src/world/chunk.js`)
- **Chunk coordinates** are in world space divided by `CHUNK_SIZE` (16)
- Chunks use **flat Uint8Array** for block storage: `index = x + CHUNK_SIZE * (z + CHUNK_SIZE * y)`
- Meshing uses **InstancedMesh** per block type for performance (one draw call per material)
- Chunks activate/deactivate based on player render distance, with async build queue

Example chunk key generation:
```javascript
function chunkKey(x, z) {
  return `${x},${z}`;  // Y not included - chunks are vertical columns
}
```

### Block System (`src/world/blockTypes.js`)
- Blocks are **numeric IDs** (0 = AIR, 1 = GRASS, etc.)
- `BLOCK_DEFINITIONS` stores metadata (solid, transparent, selectable, **tickable**)
- Only **selectable blocks** appear in player inventory (`SELECTABLE_BLOCK_IDS`)
- Transparency affects rendering: water/leaves use alpha blending
- **Tickable blocks**: SAPLING, WHEAT stages, WATER_FLOWING - updated via tick system
- **New blocks**: WATER_FLOWING (8), SAPLING (9), WHEAT stages (10-12), COBBLESTONE (13), GRAVEL (14)

### Procedural Terrain (`src/world/terrainGenerator.js`)
- Uses **layered FractalNoise** with different scales:
  - Continental (0.004) → large-scale height variation
  - Detail (0.01) → medium hills
  - Rough (0.04) → fine surface detail
- **Biome System** (5 biomes):
  - DESERT: Flat sandy terrain, no flora
  - PLAINS: Grass with wheat fields, sparse trees
  - FOREST: Dense trees and saplings
  - MOUNTAINS: High elevation, rocky peaks (cobblestone/stone)
  - BEACH: Sandy areas near water (Y = seaLevel ± 2)
- Biome stored per-chunk in `chunk.biomeData` Uint8Array
- Sea level at Y=22 by default
- Flora placement is biome-specific with deterministic hashing

### Texture Generation (`src/textures/textureFactory.js`)
- **All textures generated via Canvas API** (no image files)
- Each material created from scratch: gradients, speckles, noise
- Textures use `NearestFilter` for pixel-art aesthetic
- Example pattern: grass uses vertical gradient + fine noise + green speckles

### Player Physics & Camera (`src/player/player.js`)
- **Capsule collision** (radius 0.38, height 1.8)
- Gravity at 24 units/s², jump strength 9 units/s
- Sprint speed 8.5 vs walk 5 units/s
- Collision checks sweep all 6 cardinal directions per frame
- **Camera modes** (cycle with F5):
  - `'fps'` - First person view at eye height
  - `'tps'` - Third person view with collision-aware camera positioning
  - `'fly'` - Freecam mode with no collision, use Space/Shift for vertical movement
- **Dynamic FOV system**:
  - Sprint adds +8 FOV boost (smoothly animated)
  - Manual zoom: `+/-` keys or mouse wheel (when Shift held or in TPS mode)
  - Reset zoom: `0` key returns to default FOV
  - TPS distance: Mouse wheel (without Shift) adjusts camera distance (2.5-12 units)
  - Zoom range: 20-120 FOV with smooth damping

## Gameplay Mechanics

### Flora System
- **Sapling Placement**: Place on grass/dirt, grows into full tree after ~3.3 seconds
- **Tree Growth**: Checks 6 blocks vertical space, fails gracefully if obstructed
- **Wheat Farming**: Naturally spawns in Plains biome, grows through 3 stages (~7.5s total)
- **Biome-Specific Spawning**:
  - Forest: 4% trees, 6% saplings
  - Plains: 2% trees, 8% wheat
  - Mountains: 1.5% sparse trees
  - Desert/Beach: No flora

### Water Physics
- **Source Blocks** (WATER): Player-placed, spreads infinitely in 4 directions + down
- **Flowing Blocks** (WATER_FLOWING): Generated by sources, only flows downward
- **Flow Mechanics**: Prioritizes downward, then spreads horizontally one block at a time
- **Performance**: 5 blocks/frame prevents lag, queued updates via Set
- **Interaction**: Digging removes water, triggers neighbor recalculation

### Biome Effects
- **Terrain Height**: Desert 0.7x, Plains 1.0x, Mountains 1.6x
- **Surface Blocks**: Desert/Beach = Sand, Mountains = Cobblestone/Stone, Forest/Plains = Grass
- **Subsurface**: Desert has sand layers, Mountains are rocky, others use dirt
- **Underground Variety**: 2% gravel, 2% cobblestone spawns in stone layers

## Controls & Keybindings

### Movement
- `WASD` / Arrow Keys - Walk/strafe
- `Shift` - Sprint (1.7x speed in walk, 1.75x in fly mode)
- `Space` - Jump (FPS mode) / Fly up (fly mode)
- `Shift` - Fly down (fly mode only)
- `Mouse` - Look around (pointer locked)

### Camera & View
- `F5` - Cycle camera modes: FPS → TPS → Fly
- `+/=` or `NumpadAdd` - Zoom in (decrease FOV)
- `-` or `NumpadSubtract` - Zoom out (increase FOV)
- `0` or `Numpad0` - Reset zoom to default FOV
- `Mouse Wheel` (Shift held) - Adjust FOV zoom
- `Mouse Wheel` (TPS mode, no Shift) - Adjust camera distance

### Block Interaction
- `Left Click` - Dig/remove block
- `Right Click` - Place selected block
- `1-5` - Select block from hotbar palette
- `Mouse Wheel` (Alt/Ctrl held) - Cycle through block palette

## Development Workflow

### Build & Run
```bash
npm install          # Install Three.js + Vite
npm run dev          # Start dev server at localhost:5173
npm run build        # Production build to dist/
npm run preview      # Preview production build
```

### Hot Module Replacement
Vite HMR is enabled. When editing code:
- Scene/mesh changes reflect instantly
- Game state persists (player position, chunks)
- `import.meta.hot.dispose()` in `main.js` handles cleanup

### Debugging Tips
- **Chunk visualization**: Each chunk is a `THREE.Group` named `chunk-${x}-${z}`
- **Block raycasting**: `game._raycast()` returns `{position, normal}` for dig/place
- **Performance**: Check `world.buildQueue.length` - high values = meshing bottleneck
- Use browser DevTools 3D view to inspect scene hierarchy

## Adding New Block Types

1. Add ID to `BLOCKS` enum in `blockTypes.js`
2. Define properties in `BLOCK_DEFINITIONS` (solid, transparent, selectable)
3. Create material in `textureFactory.js` → `_createMaterial(blockId)`
4. Add to `SELECTABLE_BLOCK_IDS` if placeable
5. Update terrain generator if naturally occurring

Example:
```javascript
// blockTypes.js
export const BLOCKS = {
  // ... existing
  COBBLESTONE: 8
};

export const BLOCK_DEFINITIONS = {
  [BLOCKS.COBBLESTONE]: {
    id: BLOCKS.COBBLESTONE,
    name: 'Cobblestone',
    solid: true,
    transparent: false,
    selectable: true
  }
};
```

## Performance Considerations

- **Chunk rebuild throttle**: `rebuildPerFrame: 2` in `world.js` - increase if chunks load slowly
- **Render distance**: Default 4 chunks (viewable area = 9×9 chunks). Increase = more memory
- **Instanced rendering**: Each block type = 1 draw call per chunk (efficient for thousands of blocks)
- **Raycaster far distance**: 10 units for block interaction (increase for longer reach)

## Common Gotchas

- **World coordinates vs chunk-local**: Always convert via `chunk.worldPosition(localX, localZ)`
- **Y-axis limits**: Chunks are `CHUNK_HEIGHT` (64) tall - placing blocks above crashes
- **Dirty flag**: After `setBlock()`, chunk must be rebuilt via `markDirty()` + build queue
- **Pointer lock**: Controls only active when `player.isLocked()` returns true
- **Water rendering**: Only exposed water faces rendered (culled if adjacent to water)
- **Camera mode state**: Fly mode disables physics; switching back to FPS/TPS resets velocity
- **FOV animation**: Manual FOV changes are smoothed with damping factor 12 over delta time
- **TPS collision**: Third-person camera raycasts against `world.intersectableMeshes` to avoid clipping through terrain

## Testing Patterns

No formal test suite exists. Manual testing workflow:
1. Modify code → save (HMR applies changes)
2. Click "Enter World" to test controls
3. Use browser console: `window.game` is accessible for live debugging
4. Check performance via DevTools performance profiler

## Implemented Systems

### ✅ Biome System (IMPLEMENTED)
Fully functional biome generation with 5 distinct biomes:
- **DESERT** (biomeValue < -0.3, moisture < 0): Flat sandy terrain, 0.7x height modifier
- **PLAINS** (default): Grass with wheat spawns (8% chance), sparse trees (2%)
- **FOREST** (moisture > 0.3): Dense trees (4%), saplings (6%)
- **MOUNTAINS** (biomeValue > 0.5 or height > seaLevel+15): 1.6x height, rocky peaks
- **BEACH** (height near seaLevel ± 2): Sandy transition zones

Biome data stored in `chunk.biomeData` Uint8Array for future AI/gameplay features.

### ✅ Flora Growth Ticks (IMPLEMENTED)
Fully automated block tick system in `World`:
- **Sapling → Tree**: 200 ticks (~3.3s at 60fps), checks space, grows 4-6 block trunk + leaf sphere
- **Wheat Growth**: 3 stages (WHEAT_STAGE_1 → 2 → 3), 150 ticks per stage (~2.5s)
- `World.tickedBlocks` Map tracks all tickable blocks with `{ x, y, z, blockId, tickCount, maxTicks }`
- Processes max 10 blocks/frame via `_processTicks(delta)`
- Blocks auto-register when placed via `setBlock()` if `BLOCK_DEFINITIONS[id].tickable === true`

### ✅ Water Flow Simulation (IMPLEMENTED)
Performance-optimized water physics:
- **WATER** (source block, placed by player): Spreads horizontally + downward
- **WATER_FLOWING** (generated): Only flows downward, doesn't spread horizontally
- Queue-based updates: `World.waterFlowQueue` Set, processes 5 blocks/frame
- Flow priority: Down first, then horizontal (4 directions)
- Triggered on water placement/removal, checks all 6 neighbors
- Auto-stops at solid blocks via `BLOCK_DEFINITIONS[blockId].solid`

### Key Implementation Files
- `src/world/terrainGenerator.js` - Biome logic in `_getBiome()`, `_getSurfaceBlock()`, biome-specific flora
- `src/world/world.js` - Tick system: `tickedBlocks` Map, `_processTicks()`, water flow: `waterFlowQueue` Set, `_processWaterFlow()`
- `src/world/blockTypes.js` - 15 block types including tickable flora and water variants
- `src/world/chunk.js` - `biomeData` Uint8Array stores biome per XZ column
- `src/textures/textureFactory.js` - Procedural textures for all new blocks (sapling, wheat, cobblestone, gravel)

## External Dependencies

- **Three.js** (v0.161.0): Core 3D engine
- **Vite** (v5.2.0): Build tool and dev server
- **PointerLockControls**: From `three/addons` - handles mouse look
